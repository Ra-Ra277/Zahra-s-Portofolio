<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Labirin Aksara v2.0</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+Javanese&family=Noto+Sans+Balinese&family=Noto+Sans+Buginese&display=swap');

        :root {
            --bg-color: #2c241b;
            --gold: #d4af37;
            --wood: #8b5a2b;
            --moss: #4a5d23;
            --cream: #f4e4bc;
            --red-accent: #cc4444;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--cream);
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
            touch-action: none; /* Prevent scroll on mobile */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            aspect-ratio: 16/9;
            background: #000;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border: 4px solid var(--gold);
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: pixelated; /* Retro look */
        }

        /* UI Overlays */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 15px;
            box-sizing: border-box;
            z-index: 10;
        }

        .hud {
            display: flex;
            justify-content: space-between;
            font-size: 14px; /* Larger for readability */
            text-shadow: 2px 2px 0 #000;
        }

        /* Screens (Start, Victory, Game Over) */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(44, 36, 27, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            pointer-events: auto;
            z-index: 100;
            transition: opacity 0.3s;
        }

        .hidden { 
            display: none !important; 
        }

        h1 { font-size: 20px; color: var(--gold); margin-bottom: 10px; line-height: 1.5; }
        h2 { font-size: 14px; color: var(--wood); margin-bottom: 20px; }
        p { font-size: 10px; line-height: 1.8; max-width: 80%; margin: 10px auto; font-family: 'Arial', sans-serif; color: #ddd; }

        .btn {
            background: var(--wood);
            color: var(--cream);
            border: 2px solid var(--gold);
            padding: 15px 30px;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            cursor: pointer;
            margin-top: 20px;
            text-transform: uppercase;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.5);
        }
        .btn:hover { background: var(--moss); transform: scale(1.05); }
        .btn:active { transform: scale(0.95); }

        /* Level Title Transition */
        #level-title-overlay {
            position: absolute;
            top: 40%;
            width: 100%;
            text-align: center;
            font-size: 24px;
            color: var(--gold);
            text-shadow: 3px 3px 0 #000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 90;
        }

        /* Puzzle Interface */
        #puzzle-interface {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            height: 85%;
            background: #f4e4bc;
            border: 6px solid var(--wood);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            color: #2c241b;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            z-index: 200;
            border-radius: 8px;
        }

        .puzzle-header {
            background: var(--wood);
            color: var(--cream);
            width: 100%;
            text-align: center;
            padding: 10px 0;
            margin-top: -20px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .puzzle-word { font-size: 32px; margin-bottom: 30px; font-weight: bold; color: var(--moss); letter-spacing: 2px; }

        .puzzle-slots { display: flex; gap: 15px; margin-bottom: 30px; }
        .slot {
            width: 60px; height: 60px;
            border-bottom: 4px solid var(--wood);
            background: rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: center;
            font-size: 32px; cursor: pointer;
        }

        .puzzle-options { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; max-width: 90%; }
        .option-tile {
            background: var(--wood); color: var(--cream);
            padding: 10px 20px; border-radius: 6px;
            cursor: pointer; font-size: 28px;
            border: 2px solid var(--gold);
            box-shadow: 3px 3px 0 rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        .option-tile:active { transform: scale(0.9); }

        /* Font Specifics */
        .script-jawa { font-family: 'Noto Sans Javanese', sans-serif; }
        .script-bali { font-family: 'Noto Sans Balinese', sans-serif; }
        .script-lontara { font-family: 'Noto Sans Buginese', sans-serif; }

        /* Pustaka Grid */
        .pustaka-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px; width: 90%; max-height: 50vh; overflow-y: auto; margin: 20px 0;
        }
        .pustaka-card {
            background: #fff; color: #333; padding: 10px;
            border: 2px solid var(--wood); border-radius: 4px;
        }

        /* Mobile Controls */
        .controls {
            position: absolute; bottom: 10px; width: 100%; height: 120px;
            pointer-events: none; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box;
            z-index: 80;
        }
        .control-group { pointer-events: auto; display: flex; gap: 15px; align-items: flex-end; }
        .touch-btn {
            width: 70px; height: 70px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; color: white; user-select: none;
            backdrop-filter: blur(2px);
        }
        .touch-btn:active { background: rgba(212, 175, 55, 0.5); transform: scale(0.95); }

        @media (min-width: 800px) { .controls { display: none; } }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas" width="800" height="450"></canvas>

    <!-- UI Overlay -->
    <div class="ui-layer">
        <div class="hud">
            <div>üî• <span id="lives">3</span></div>
            <div>LEVEL <span id="level-display">1</span></div>
        </div>
    </div>

    <!-- Level Title Toast -->
    <div id="level-title-overlay">AREA 1: JAWA</div>

    <!-- Start Screen -->
    <div id="start-screen" class="screen">
        <h1>LABIRIN AKSARA</h1>
        <p style="color: var(--gold); margin-bottom: 20px;">Menyusun Jejak, Menjaga Tradisi</p>
        <p>Gunakan Panah/WASD untuk bergerak.<br>Spasi/Tombol untuk Lompat.</p>
        <button class="btn" onclick="startGame()">Mulai Petualangan</button>
    </div>

    <!-- Puzzle UI -->
    <div id="puzzle-interface">
        <div class="puzzle-header">SUSUN KATA</div>
        <div class="puzzle-word" id="puzzle-question">MAKAN</div>
        <div class="puzzle-slots" id="puzzle-slots"></div>
        <div class="puzzle-options" id="puzzle-options"></div>
        <p style="color: #666; font-size: 10px; margin-top:20px;">Klik aksara di bawah untuk mengisi kotak.</p>
    </div>

    <!-- Game Over -->
    <div id="game-over-screen" class="screen hidden">
        <h1 style="color: var(--red-accent);">OBOR PADAM</h1>
        <p>Jangan menyerah. Tradisi butuh penjaga sepertimu.</p>
        <button class="btn" onclick="restartLevel()">Coba Lagi</button>
    </div>

    <!-- Victory Level -->
    <div id="victory-screen" class="screen hidden">
        <h1>LEVEL SELESAI!</h1>
        <p>Gerbang terbuka. Pengetahuan baru didapatkan.</p>
        <button class="btn" onclick="nextLevel()">Lanjut ke Daerah Berikutnya</button>
    </div>

    <!-- Final Pustaka -->
    <div id="pustaka-screen" class="screen hidden">
        <h1>PUSTAKA BUDAYA</h1>
        <p>Semua kepingan telah terkumpul.</p>
        <div class="pustaka-grid" id="pustaka-content"></div>
        <button class="btn" onclick="location.reload()">Kembali ke Menu Utama</button>
    </div>

    <!-- Mobile Controls -->
    <div class="controls">
        <div class="control-group">
            <div class="touch-btn" id="btn-left">‚Üê</div>
            <div class="touch-btn" id="btn-right">‚Üí</div>
        </div>
        <div class="control-group">
            <div class="touch-btn" id="btn-jump">‚Üë</div>
        </div>
    </div>
</div>

<script>
    /* ENGINE SETUP */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // Core Game State
    let gameState = 'MENU'; // MENU, PLAY, PUZZLE, GAMEOVER, VICTORY, TRANSITION
    let currentLevel = 1;
    let lives = 3;
    let animationId; // Penting untuk kontrol loop
    let frameCount = 0;

    // Inputs
    const keys = { right: false, left: false, up: false };
    
    // Physics Constants
    const GRAVITY = 0.6;
    const JUMP_FORCE = -11;
    const SPEED = 4.5;

    // Data Level
    const LEVELS = [
        {
            id: 1, name: "JAWA (Mataraman)",
            sky: ['#FFD700', '#FF8C00'], // Sunset
            groundColor: '#8B4513',
            scriptClass: 'script-jawa',
            puzzles: [
                { id: "p1", ind: "NASI", native: ["Í¶±Í¶º", "Í¶í"], readable: "Sega" },
                { id: "p2", ind: "RUMAH", native: ["Í¶é", "Í¶©Í¶É"], readable: "Omah" }
            ]
        },
        {
            id: 2, name: "BALI (Dewata)",
            sky: ['#87CEEB', '#E0F7FA'], // Blue Sky
            groundColor: '#F4A460', // Sand color
            scriptClass: 'script-bali',
            puzzles: [
                { id: "p3", ind: "AIR", native: ["·¨¢·¨∂", "·¨É", "·¨¢"], readable: "Tirta" },
                { id: "p4", ind: "SELAMAT", native: ["·¨≠", "·¨≥", "·¨öÍ¶º", "Í¶Å"], readable: "Rahajeng" }
            ]
        },
        {
            id: 3, name: "SULSEL (Phinisi)",
            sky: ['#2F4F4F', '#708090'], // Misty/Cloudy
            groundColor: '#556B2F', // Karst Moss
            scriptClass: 'script-lontara',
            puzzles: [
                { id: "p5", ind: "GUNUNG", native: ["·®Ö·®ò", "·®í·®ò"], readable: "Bulu" },
                { id: "p6", ind: "HARGA DIRI", native: ["·®î·®ó", "·®ë·®ó"], readable: "Siri" }
            ]
        }
    ];

    let collectedWords = []; 

    // Entities
    let player = { x: 50, y: 200, w: 25, h: 40, vx: 0, vy: 0, grounded: false, facingRight: true };
    let cameraX = 0;
    let platforms = [];
    let gates = [];
    let activePuzzle = null;
    let puzzleInput = [];
    let decor = [];

    /* --- INITIALIZATION & LEVEL GEN --- */

    function startGame() {
        document.getElementById('start-screen').classList.add('hidden');
        lives = 3;
        currentLevel = 1;
        updateHud();
        initLevel(currentLevel);
    }

    function initLevel(levelIdx) {
        // Reset Physics
        player.x = 50; 
        player.y = 200; 
        player.vx = 0; 
        player.vy = 0;
        cameraX = 0;
        player.grounded = false;

        // Clean arrays
        platforms = [];
        gates = [];
        decor = [];

        const lvlData = LEVELS[levelIdx - 1];

        // Generate Terrain (Procedural sederhana)
        let cx = 0;
        const groundY = 350;

        // Buat lantai yang panjang dengan beberapa lubang
        for(let i=0; i<35; i++) {
            // Lubang pada indeks tertentu
            let isGap = (i === 6 || i === 14 || i === 22);
            
            if(!isGap) {
                platforms.push({ x: cx, y: groundY, w: 100, h: 100, type: 'ground' });
                
                // Dekorasi Random (Pohon/Batu)
                if(Math.random() > 0.7) {
                    decor.push({x: cx + 20, y: groundY, type: (Math.random() > 0.5 ? 'tree' : 'rock')});
                }
            } else {
                // Platform melayang di atas lubang
                platforms.push({ x: cx + 10, y: groundY - 60 - (Math.random()*40), w: 80, h: 20, type: 'plat' });
            }
            
            // Platform tinggi tambahan
            if(i % 5 === 0 && i > 0) {
                platforms.push({ x: cx, y: groundY - 100, w: 80, h: 20, type: 'plat' });
            }

            cx += 100;
        }

        // Penempatan Gerbang (Puzzle)
        // Gerbang 1
        gates.push({ x: 700, y: groundY - 100, w: 40, h: 100, type: 'puzzle', puzzle: lvlData.puzzles[0], solved: false });
        // Gerbang 2
        gates.push({ x: 1900, y: groundY - 100, w: 40, h: 100, type: 'puzzle', puzzle: lvlData.puzzles[1], solved: false });
        // Finish
        gates.push({ x: 3000, y: groundY - 100, w: 50, h: 100, type: 'finish', solved: false });

        // Update UI Text
        document.getElementById('level-display').innerText = currentLevel;
        showLevelTitle(lvlData.name);

        // Start Loop
        gameState = 'PLAY';
        if(animationId) cancelAnimationFrame(animationId);
        loop();
    }

    function showLevelTitle(text) {
        const el = document.getElementById('level-title-overlay');
        el.innerText = `AREA ${currentLevel}: ${text}`;
        el.style.opacity = 1;
        setTimeout(() => { el.style.opacity = 0; }, 2000);
    }

    /* --- GAME LOOP & LOGIC --- */

    function loop() {
        if(gameState === 'PLAY' || gameState === 'TRANSITION') {
            update();
            draw();
            animationId = requestAnimationFrame(loop);
        }
    }

    function update() {
        if(gameState !== 'PLAY') return;

        // Input Movement
        if (keys.right) { player.vx = SPEED; player.facingRight = true; }
        else if (keys.left) { player.vx = -SPEED; player.facingRight = false; }
        else { player.vx = 0; }

        // Jump
        if (keys.up && player.grounded) {
            player.vy = JUMP_FORCE;
            player.grounded = false;
        }

        // Gravity & Velocity
        player.vy += GRAVITY;
        player.x += player.vx;
        player.y += player.vy;

        // Collision Detection
        player.grounded = false;
        platforms.forEach(p => {
            if (rectIntersect(player.x, player.y, player.w, player.h, p.x, p.y, p.w, p.h)) {
                // Deteksi sisi tabrakan sederhana
                const overlapX = (player.w + p.w)/2 - Math.abs((player.x + player.w/2) - (p.x + p.w/2));
                const overlapY = (player.h + p.h)/2 - Math.abs((player.y + player.h/2) - (p.y + p.h/2));

                if (overlapX < overlapY) {
                    // Nabrak samping
                    player.x -= (player.vx > 0 ? overlapX : -overlapX);
                    player.vx = 0;
                } else {
                    // Nabrak atas/bawah
                    if (player.vy > 0) { // Jatuh ke lantai
                        player.y -= overlapY;
                        player.vy = 0;
                        player.grounded = true;
                    } else { // Jedot kepala
                        player.y += overlapY;
                        player.vy = 0;
                    }
                }
            }
        });

        // Jatuh ke jurang
        if(player.y > canvas.height + 50) {
            hurtPlayer();
        }

        // Interaksi Gerbang
        gates.forEach(g => {
            if (!g.solved && rectIntersect(player.x, player.y, player.w, player.h, g.x, g.y, g.w, g.h)) {
                if(g.type === 'finish') {
                    levelComplete();
                } else {
                    triggerPuzzle(g);
                }
            }
        });

        // Camera Follow
        const targetCamX = player.x - 200;
        cameraX += (targetCamX - cameraX) * 0.1;
        if(cameraX < 0) cameraX = 0;

        frameCount++;
    }

    function rectIntersect(x1, y1, w1, h1, x2, y2, w2, h2) {
        return x2 < x1 + w1 && x2 + w2 > x1 && y2 < y1 + h1 && y2 + h2 > y1;
    }

    function hurtPlayer() {
        lives--;
        updateHud();
        // Respawn sedikit ke belakang
        player.x = Math.max(50, player.x - 150);
        player.y = 200;
        player.vy = 0;
        
        if(lives <= 0) {
            gameState = 'GAMEOVER';
            document.getElementById('game-over-screen').classList.remove('hidden');
        }
    }

    function restartLevel() {
        document.getElementById('game-over-screen').classList.add('hidden');
        lives = 3;
        updateHud();
        initLevel(currentLevel);
    }

    function levelComplete() {
        gameState = 'VICTORY';
        document.getElementById('victory-screen').classList.remove('hidden');
    }

    // FIX: Fungsi ini diperbaiki untuk memastikan loop restart
    function nextLevel() {
        document.getElementById('victory-screen').classList.add('hidden');
        currentLevel++;
        
        if (currentLevel > 3) {
            showPustaka();
        } else {
            // Pastikan state diubah sebelum init
            gameState = 'TRANSITION'; 
            initLevel(currentLevel); // initLevel akan memanggil loop() di akhirnya
        }
    }

    function updateHud() {
        document.getElementById('lives').innerText = lives;
    }

    /* --- PUZZLE SYSTEM --- */

    function triggerPuzzle(gate) {
        gameState = 'PUZZLE';
        activePuzzle = gate;
        
        const ui = document.getElementById('puzzle-interface');
        ui.style.display = 'flex';
        
        document.getElementById('puzzle-question').innerText = gate.puzzle.ind;
        
        const slotsDiv = document.getElementById('puzzle-slots');
        slotsDiv.innerHTML = '';
        puzzleInput = [];

        // Buat Slot Kosong
        gate.puzzle.native.forEach((char, i) => {
            const s = document.createElement('div');
            s.className = `slot ${LEVELS[currentLevel-1].scriptClass}`;
            s.id = `slot-${i}`;
            s.onclick = () => clearSlot(i);
            slotsDiv.appendChild(s);
            puzzleInput.push(null);
        });

        // Buat Pilihan Aksara (Termasuk Pengalih)
        const optsDiv = document.getElementById('puzzle-options');
        optsDiv.innerHTML = '';
        let options = [...gate.puzzle.native];
        
        // Tambah aksara acak sebagai pengalih
        const decoys = ["Í¶è","Í¶´","·¨¶","·¨´","·®Ü","·®à"]; 
        options.push(decoys[Math.floor(Math.random()*decoys.length)]);
        options.push(decoys[Math.floor(Math.random()*decoys.length)]);
        options.sort(() => Math.random() - 0.5);

        options.forEach(char => {
            const btn = document.createElement('div');
            btn.className = `option-tile ${LEVELS[currentLevel-1].scriptClass}`;
            btn.innerText = char;
            btn.onclick = () => fillSlot(char);
            optsDiv.appendChild(btn);
        });
    }

    function fillSlot(char) {
        const idx = puzzleInput.findIndex(v => v === null);
        if(idx !== -1) {
            puzzleInput[idx] = char;
            document.getElementById(`slot-${idx}`).innerText = char;
            
            // Cek jika penuh
            if(!puzzleInput.includes(null)) {
                setTimeout(checkSolution, 300);
            }
        }
    }

    function clearSlot(idx) {
        puzzleInput[idx] = null;
        document.getElementById(`slot-${idx}`).innerText = '';
    }

    function checkSolution() {
        const correct = activePuzzle.puzzle.native;
        const isCorrect = puzzleInput.every((v, i) => v === correct[i]);

        if(isCorrect) {
            // Benar
            activePuzzle.solved = true;
            
            // Simpan ke Pustaka
            if(!collectedWords.find(w => w.id === activePuzzle.puzzle.id)) {
                collectedWords.push({
                    ...activePuzzle.puzzle,
                    area: LEVELS[currentLevel-1].name,
                    cls: LEVELS[currentLevel-1].scriptClass
                });
            }

            document.getElementById('puzzle-interface').style.display = 'none';
            activePuzzle = null;
            gameState = 'PLAY';
            loop(); // Lanjutkan loop utama
        } else {
            // Salah
            hurtPlayer();
            // Reset puzzle visual
            puzzleInput.fill(null);
            document.querySelectorAll('.slot').forEach(el => el.innerText = '');
            if(gameState === 'GAMEOVER') {
                document.getElementById('puzzle-interface').style.display = 'none';
            }
        }
    }

    /* --- PUSTAKA & DRAWING --- */

    function showPustaka() {
        gameState = 'PUSTAKA';
        const screen = document.getElementById('pustaka-screen');
        screen.classList.remove('hidden');
        const grid = document.getElementById('pustaka-content');
        grid.innerHTML = '';
        
        if(collectedWords.length === 0) {
            grid.innerHTML = '<p>Belum ada aksara yang terkumpul.</p>';
            return;
        }

        collectedWords.forEach(w => {
            const card = document.createElement('div');
            card.className = 'pustaka-card';
            card.innerHTML = `
                <div style="font-size:10px; color:#888;">${w.area}</div>
                <div style="font-weight:bold; color:var(--moss);">${w.ind}</div>
                <div class="${w.cls}" style="font-size:24px; margin:5px 0;">${w.native.join('')}</div>
                <div style="font-style:italic; font-size:12px;">"${w.readable}"</div>
            `;
            grid.appendChild(card);
        });
    }

    function draw() {
        const lvl = LEVELS[currentLevel-1];
        
        // 1. Sky Gradient
        const grd = ctx.createLinearGradient(0, 0, 0, canvas.height);
        grd.addColorStop(0, lvl.sky[0]);
        grd.addColorStop(1, lvl.sky[1]);
        ctx.fillStyle = grd;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // 2. Parallax Mountains
        ctx.save();
        ctx.translate(-cameraX * 0.2, 0); // Slow parallax
        ctx.fillStyle = "rgba(0,0,0,0.1)";
        for(let i=0; i<5; i++) {
            ctx.beginPath();
            ctx.moveTo(i*400, canvas.height);
            ctx.lineTo(i*400 + 200, canvas.height - 250);
            ctx.lineTo(i*400 + 400, canvas.height);
            ctx.fill();
        }
        ctx.restore();

        ctx.save();
        ctx.translate(-cameraX, 0);

        // 3. Decor
        decor.forEach(d => {
            if(d.type === 'tree') drawTree(d.x, d.y);
            else drawRock(d.x, d.y);
        });

        // 4. Platforms
        ctx.fillStyle = lvl.groundColor;
        platforms.forEach(p => {
            ctx.fillRect(p.x, p.y, p.w, p.h);
            // Grass topper
            ctx.fillStyle = "rgba(0,0,0,0.2)";
            ctx.fillRect(p.x, p.y, p.w, 5);
            ctx.fillStyle = lvl.groundColor; // reset
        });

        // 5. Gates
        gates.forEach(g => {
            if(g.solved) return; // Hide if solved
            
            if(g.type === 'finish') {
                ctx.fillStyle = '#FFD700'; // Gold finish
                ctx.fillRect(g.x, g.y, g.w, g.h);
                // Flag
                ctx.fillStyle = 'red'; ctx.fillRect(g.x+10, g.y-40, 30, 20);
                ctx.fillStyle = 'white'; ctx.fillRect(g.x+10, g.y-40, 15, 20);
                ctx.fillStyle = 'brown'; ctx.fillRect(g.x, g.y-40, 5, 140);
            } else {
                // Puzzle Gate
                ctx.fillStyle = '#444';
                ctx.fillRect(g.x, g.y, g.w, g.h);
                ctx.fillStyle = '#FFF';
                ctx.font = '20px Arial';
                ctx.fillText("?", g.x + 10, g.y + 50);
            }
        });

        // 6. Player
        drawPlayer();

        ctx.restore();
    }

    function drawPlayer() {
        const x = player.x; 
        const y = player.y;
        
        // Simple Pixel Art
        // Tunic
        ctx.fillStyle = '#d4af37'; 
        ctx.fillRect(x, y + 10, player.w, player.h - 10);
        // Head
        ctx.fillStyle = '#f4c2c2'; 
        ctx.fillRect(x + 2, y, player.w - 4, 15);
        // Blangkon
        ctx.fillStyle = '#654321';
        ctx.fillRect(x, y - 4, player.w, 8);
        
        // Eye
        ctx.fillStyle = 'black';
        if(player.facingRight) ctx.fillRect(x + 16, y + 5, 3, 3);
        else ctx.fillRect(x + 6, y + 5, 3, 3);

        // Bag
        ctx.fillStyle = '#8B4513';
        ctx.fillRect(x + (player.facingRight ? 0 : 15), y + 15, 10, 15);
    }

    function drawTree(x, y) {
        ctx.fillStyle = "#8B4513"; ctx.fillRect(x+10, y-60, 10, 60);
        ctx.fillStyle = "#228B22"; 
        ctx.beginPath(); ctx.arc(x+15, y-70, 25, 0, Math.PI*2); ctx.fill();
    }
    function drawRock(x, y) {
        ctx.fillStyle = "#808080";
        ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x+15, y-25); ctx.lineTo(x+30, y); ctx.fill();
    }

    /* --- INPUT HANDLING --- */
    window.addEventListener('keydown', e => {
        if(gameState !== 'PLAY') return;
        if(e.code==='ArrowRight'||e.code==='KeyD') keys.right=true;
        if(e.code==='ArrowLeft'||e.code==='KeyA') keys.left=true;
        if(e.code==='ArrowUp'||e.code==='Space'||e.code==='KeyW') {
             keys.up=true; 
             // Langsung lompat biar responsif
             if(player.grounded) { player.vy = JUMP_FORCE; player.grounded=false; }
        }
    });
    window.addEventListener('keyup', e => {
        if(e.code==='ArrowRight'||e.code==='KeyD') keys.right=false;
        if(e.code==='ArrowLeft'||e.code==='KeyA') keys.left=false;
        if(e.code==='ArrowUp'||e.code==='Space'||e.code==='KeyW') keys.up=false;
    });

    // Touch Handling (Simple)
    const bindTouch = (id, key) => {
        const el = document.getElementById(id);
        el.addEventListener('touchstart', (e) => { 
            e.preventDefault(); 
            if(key === 'up' && player.grounded && gameState==='PLAY') {
                player.vy = JUMP_FORCE; player.grounded=false;
            }
            keys[key] = true; 
        });
        el.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
    };
    bindTouch('btn-left', 'left');
    bindTouch('btn-right', 'right');
    bindTouch('btn-jump', 'up');

    // Init first render
    ctx.fillStyle='#000'; ctx.fillRect(0,0,800,450);
</script>
</body>
</html>
